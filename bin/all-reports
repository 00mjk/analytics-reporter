#!/usr/bin/env node

/*
 * Run all analytics reports output JSON to disk.
 *
 * Usage: all-reports
 *
 * --output: Change output directory. Defaults to CWD.
 */

var Analytics = require("../analytics"),
    fs = require("fs"),
    async = require("async");


var run = function(options) {
  if (!options) options = {};
  if (!options.output) options.output = ".";

  var names = Object.keys(Analytics.reports);

  var eachReport = function(name, done) {
    var report = Analytics.reports[name];

    console.log("\n[" + report.name + "] Fetching...");
    Analytics.query(report, function(err, data) {
        if (err) return console.log("ERROR: " + JSON.stringify(err));

        console.log("[" + report.name + "] Saving report data...");
        var json = JSON.stringify(data, null, 2);
        fs.writeFileSync(options.output + "/" + report.name + ".json", json);

        console.log("[" + report.name + "] Done.");
        done();
    });
  };

  async.eachSeries(names, eachReport, function(err) {
    if (err) {
      console.error(err);
      process.exit(1);
    }

    console.log("All done.");
  });
};

run(require('minimist')(process.argv.slice(2)));
